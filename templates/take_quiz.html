<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Take Quiz - AI Quiz App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-light bg-light shadow-sm" style="backdrop-filter: blur(10px); background: rgba(255,255,255,0.85) !important;">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="/" style="font-size: 2rem; letter-spacing: 1px;">Quiziac</a>
    <button id="theme-toggle" class="btn btn-outline-primary ms-auto" onclick="toggleTheme()">
      <span id="theme-icon" class="fas fa-moon"></span>
    </button>
  </div>
</nav>
<div class="container py-5">
  <div class="glass-card p-5 shadow-lg animate__animated animate__fadeInUp" style="max-width: 700px; margin: auto;">
    <div class="mb-4">
      <h2 class="fw-bold mb-2" style="font-size:2rem;">{{ quiz.title }}</h2>
      <div class="mb-2">
        <span class="badge bg-primary me-2">Topic: {{ quiz.topic }}</span>
        <span class="badge bg-info me-2">Difficulty: {{ quiz.difficulty }}</span>
        <span class="badge bg-success me-2">Questions: {{ quiz.num_questions }}</span>
        <span class="badge bg-warning text-dark">Duration: {{ quiz.duration }} min</span>
      </div>
      {% if quiz.duration %}
      <div class="progress mb-3" style="height: 10px;">
        <div class="progress-bar" id="timerBar" role="progressbar" style="width: 100%;" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
      </div>
      <div class="mb-2"><span id="timerDisplay">{{ quiz.duration }}:00</span> left</div>
      {% endif %}
    </div>
    <div id="quizQuestions">
      <!-- Questions will be rendered here by JS -->
    </div>
    <button class="btn btn-primary btn-lg w-100 mt-4 animate__animated animate__pulse animate__infinite">Submit Quiz</button>
  </div>
</div>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
let currentQuestion = 1;
let totalQuestions = 0;
let quizData = null;
let userAnswers = {};
let quizId = null;

// Get quiz ID from URL
quizId = window.location.pathname.split('/').pop();

// Load quiz data from backend
loadQuiz();

function getToken() {
    return localStorage.getItem('token');
}
function getTenantId() {
    return localStorage.getItem('tenant_id') || '';
}

function loadQuiz() {
    const token = getToken();
    const tenant_id = getTenantId();
    if (!token || !tenant_id) return;
    fetch(`/quizzes/${quizId}?tenant_id=${tenant_id}`, {
        headers: { 'Authorization': 'Bearer ' + token }
    })
    .then(res => res.json())
    .then(data => {
        quizData = data;
        totalQuestions = data.questions.length;
        document.getElementById('quizTitle').textContent = data.title;
        displayQuestion(1);
        generateQuestionNav();
    });
}

function displayQuestion(questionNum) {
    if (!quizData || questionNum < 1 || questionNum > totalQuestions) return;
    currentQuestion = questionNum;
    const question = quizData.questions[questionNum - 1];
    document.getElementById('questionCounter').textContent = `Question ${questionNum} of ${totalQuestions}`;
    const progress = (questionNum / totalQuestions) * 100;
    document.getElementById('progressBar').style.width = progress + '%';
    document.getElementById('progressText').textContent = Math.round(progress) + '%';
    const container = document.getElementById('questionContainer');
    container.innerHTML = `
        <h5 class="mb-3">${question.question_text}</h5>
        <div class="mb-3">
            ${question.answers.map((answer, index) => `
                <div class="form-check mb-2">
                    <input class="form-check-input" type="radio" name="question${question.id}" 
                           id="answer${answer.id}" value="${answer.id}" 
                           ${userAnswers[question.id] === answer.id ? 'checked' : ''}>
                    <label class="form-check-label" for="answer${answer.id}">
                        ${String.fromCharCode(65 + index)}. ${answer.text}
                    </label>
                </div>
            `).join('')}
        </div>
    `;
    document.getElementById('prevBtn').disabled = questionNum === 1;
    if (questionNum === totalQuestions) {
        document.getElementById('nextBtn').style.display = 'none';
        document.getElementById('submitBtn').style.display = 'inline-block';
    } else {
        document.getElementById('nextBtn').style.display = 'inline-block';
        document.getElementById('submitBtn').style.display = 'none';
    }
    updateQuestionNav();
}

function generateQuestionNav() {
    const nav = document.getElementById('questionNav');
    nav.innerHTML = '';
    for (let i = 1; i <= totalQuestions; i++) {
        const btn = document.createElement('button');
        btn.className = 'btn btn-outline-primary btn-sm';
        btn.textContent = i;
        btn.onclick = () => displayQuestion(i);
        nav.appendChild(btn);
    }
}

function updateQuestionNav() {
    const buttons = document.querySelectorAll('#questionNav .btn');
    buttons.forEach((btn, index) => {
        const questionNum = index + 1;
        btn.className = 'btn btn-sm';
        if (questionNum === currentQuestion) {
            btn.className += ' btn-primary';
        } else if (userAnswers[quizData.questions[questionNum-1].id]) {
            btn.className += ' btn-success';
        } else {
            btn.className += ' btn-outline-primary';
        }
    });
}

function previousQuestion() {
    if (currentQuestion > 1) {
        saveCurrentAnswer();
        displayQuestion(currentQuestion - 1);
    }
}

function nextQuestion() {
    if (currentQuestion < totalQuestions) {
        saveCurrentAnswer();
        displayQuestion(currentQuestion + 1);
    }
}

function saveCurrentAnswer() {
    const question = quizData.questions[currentQuestion - 1];
    const selectedAnswer = document.querySelector(`input[name="question${question.id}"]:checked`);
    if (selectedAnswer) {
        userAnswers[question.id] = parseInt(selectedAnswer.value);
    }
}

function submitQuiz() {
    saveCurrentAnswer();
    // Show answer summary
    const summary = document.getElementById('answerSummary');
    let answeredCount = Object.keys(userAnswers).length;
    summary.innerHTML = `
        <div class="alert alert-info">
            <strong>${answeredCount}</strong> out of <strong>${totalQuestions}</strong> questions answered
        </div>
    `;
    const modal = new bootstrap.Modal(document.getElementById('submitModal'));
    modal.show();
}

function confirmSubmit() {
    saveCurrentAnswer();
    const token = getToken();
    const tenant_id = getTenantId();
    fetch('/submit-quiz', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({
            tenant_id: tenant_id,
            quiz_id: quizId,
            user_answers: userAnswers
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.result_id) {
            window.location.href = `/results/${data.result_id}`;
        } else {
            alert('Failed to submit quiz.');
        }
    })
    .catch(() => {
        alert('Error submitting quiz.');
    });
    const modal = bootstrap.Modal.getInstance(document.getElementById('submitModal'));
    modal.hide();
}

function logout() {
    localStorage.removeItem('token');
    window.location.href = '/login';
}

function setTheme(dark) {
  if (dark) {
    document.body.classList.add('dark-mode');
    document.getElementById('theme-icon').className = 'fas fa-sun';
    localStorage.setItem('theme', 'dark');
  } else {
    document.body.classList.remove('dark-mode');
    document.getElementById('theme-icon').className = 'fas fa-moon';
    localStorage.setItem('theme', 'light');
  }
}
function toggleTheme() {
  setTheme(!document.body.classList.contains('dark-mode'));
}
window.onload = function() {
  const theme = localStorage.getItem('theme');
  setTheme(theme === 'dark');
};
</script>
</body>
</html> 